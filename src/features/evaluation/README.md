# üìä Evaluations (√âvaluations)

Ce module g√®re le syst√®me d'√©valuation mutuelle entre freelances et entreprises apr√®s la completion des contrats sur la plateforme Synkrone.

---

## Structure du module

- **evaluation.model.ts** : Interfaces TypeScript et enums pour les √©valuations.
- **evaluation.schema.ts** : Sch√©mas Zod pour la validation des requ√™tes.
- **evaluation.repository.ts** : Acc√®s aux donn√©es (CRUD, filtres, statistiques).
- **evaluation.service.ts** : Logique m√©tier (validation, permissions, business rules).
- **evaluation.controller.ts** : Handlers Express, validation, r√©ponses JSON.
- **evaluation.route.ts** : D√©finition des routes Express avec authentification.

---

## Mod√®le de donn√©es

```ts
export enum UserType {
  FREELANCE = "freelance",
  COMPANY = "company",
}

export interface Evaluation {
  id: string;
  contract_id: string;
  evaluator_id: string;
  evaluated_id: string;
  evaluator_type: UserType;
  evaluated_type: UserType;
  rating: number;        // 1-5 √©toiles
  comment?: string;      // Commentaire optionnel
  created_at: Date;
  updated_at?: Date;
  // Relations enrichies
  contract?: {
    id: string;
    project_id: string;
    project?: {
      id: string;
      title: string;
    };
  };
  evaluator?: {
    id: string;
    name: string;
    email: string;
    type: UserType;
  };
  evaluated?: {
    id: string;
    name: string;
    email: string;
    type: UserType;
  };
}

export interface EvaluationStats {
  user_id: string;
  user_type: UserType;
  total_evaluations: number;
  average_rating: number;
  rating_distribution: {
    rating_1: number;
    rating_2: number;
    rating_3: number;
    rating_4: number;
    rating_5: number;
  };
}
```

---

## Endpoints essentiels

### 1. Cr√©er une √©valuation

`POST /api/evaluations`

**Body :**
```json
{
  "contract_id": "uuid",
  "evaluator_id": "uuid",
  "evaluated_id": "uuid",
  "evaluator_type": "freelance",
  "evaluated_type": "company",
  "rating": 5,
  "comment": "Excellente collaboration, projet bien g√©r√© et paiements rapides."
}
```

**R√©ponse :**
```json
{
  "success": true,
  "data": {
    "id": "eval-uuid",
    "contract_id": "contract-uuid",
    "evaluator_id": "freelance-uuid",
    "evaluated_id": "company-uuid",
    "evaluator_type": "freelance",
    "evaluated_type": "company",
    "rating": 5,
    "comment": "Excellente collaboration...",
    "created_at": "2024-01-15T10:30:00Z"
  },
  "message": "√âvaluation cr√©√©e avec succ√®s"
}
```

---

### 2. R√©cup√©rer une √©valuation par ID

`GET /api/evaluations/:id`

**R√©ponse :**
```json
{
  "success": true,
  "data": {
    "id": "eval-uuid",
    "rating": 5,
    "comment": "Excellente collaboration...",
    "created_at": "2024-01-15T10:30:00Z",
    "contract": {
      "id": "contract-uuid",
      "project_id": "project-uuid",
      "project": {
        "id": "project-uuid",
        "title": "D√©veloppement Application Mobile"
      }
    },
    "evaluator": {
      "id": "freelance-uuid",
      "name": "Marie Dubois",
      "email": "marie@example.com",
      "type": "freelance"
    },
    "evaluated": {
      "id": "company-uuid",
      "name": "TechCorp",
      "email": "contact@techcorp.com",
      "type": "company"
    }
  },
  "message": "√âvaluation r√©cup√©r√©e avec succ√®s"
}
```

---

### 3. R√©cup√©rer les statistiques d'un utilisateur

`GET /api/evaluations/user/:userId/stats?userType=freelance`

**R√©ponse :**
```json
{
  "success": true,
  "data": {
    "user_id": "user-uuid",
    "user_type": "freelance",
    "total_evaluations": 28,
    "average_rating": 4.6,
    "rating_distribution": {
      "rating_1": 0,
      "rating_2": 1,
      "rating_3": 2,
      "rating_4": 8,
      "rating_5": 17
    }
  },
  "message": "Statistiques d'√©valuation r√©cup√©r√©es avec succ√®s"
}
```

---

### 4. R√©cup√©rer les √©valuations re√ßues par un utilisateur

`GET /api/evaluations/user/:userId/received?page=1&limit=10`

**R√©ponse :**
```json
{
  "success": true,
  "data": [
    {
      "id": "eval-uuid-1",
      "rating": 5,
      "comment": "Travail exceptionnel, tr√®s professionnel",
      "created_at": "2024-01-15T10:30:00Z",
      "evaluator": {
        "name": "TechCorp",
        "type": "company"
      },
      "contract": {
        "project": {
          "title": "D√©veloppement API REST"
        }
      }
    }
  ],
  "total": 28,
  "page": 1,
  "limit": 10,
  "totalPages": 3,
  "message": "√âvaluations re√ßues r√©cup√©r√©es avec succ√®s"
}
```

---

### 5. R√©cup√©rer les √©valuations d'un contrat

`GET /api/evaluations/contract/:contractId`

**R√©ponse :**
```json
{
  "success": true,
  "data": [
    {
      "id": "eval-uuid-1",
      "evaluator_type": "freelance",
      "evaluated_type": "company",
      "rating": 5,
      "comment": "Excellente collaboration",
      "evaluator": {
        "name": "Marie Dubois",
        "type": "freelance"
      }
    },
    {
      "id": "eval-uuid-2",
      "evaluator_type": "company",
      "evaluated_type": "freelance",
      "rating": 5,
      "comment": "Travail remarquable, tr√®s professionnel",
      "evaluator": {
        "name": "TechCorp",
        "type": "company"
      }
    }
  ],
  "total": 2,
  "message": "√âvaluations du contrat r√©cup√©r√©es avec succ√®s"
}
```

---

### 6. V√©rifier si un utilisateur peut √©valuer

`GET /api/evaluations/contract/:contractId/can-evaluate`

**R√©ponse :**
```json
{
  "success": true,
  "data": {
    "canEvaluate": true,
    "targetUser": {
      "id": "company-uuid",
      "type": "company",
      "name": "TechCorp"
    }
  },
  "message": "L'utilisateur peut √©valuer"
}
```

**Ou si l'utilisateur ne peut pas √©valuer :**
```json
{
  "success": true,
  "data": {
    "canEvaluate": false,
    "reason": "Vous avez d√©j√† √©valu√© ce contrat"
  },
  "message": "L'utilisateur ne peut pas √©valuer"
}
```

---

### 7. R√©cup√©rer un r√©sum√© complet des √©valuations

`GET /api/evaluations/user/:userId/summary`

**R√©ponse :**
```json
{
  "success": true,
  "data": {
    "stats": {
      "user_id": "user-uuid",
      "user_type": "freelance",
      "total_evaluations": 28,
      "average_rating": 4.6,
      "rating_distribution": {
        "rating_1": 0,
        "rating_2": 1,
        "rating_3": 2,
        "rating_4": 8,
        "rating_5": 17
      }
    },
    "recentEvaluations": [
      {
        "id": "eval-uuid-1",
        "rating": 5,
        "comment": "Travail exceptionnel",
        "created_at": "2024-01-15T10:30:00Z",
        "evaluator": {
          "name": "TechCorp",
          "type": "company"
        }
      }
    ],
    "canEvaluateContracts": []
  },
  "message": "R√©sum√© des √©valuations r√©cup√©r√© avec succ√®s"
}
```

---

### 8. Mettre √† jour une √©valuation

`PATCH /api/evaluations/:id`

**Body :**
```json
{
  "rating": 4,
  "comment": "Tr√®s bonne collaboration, quelques petites am√©liorations possibles sur la communication."
}
```

**Contraintes :**
- Seul l'auteur de l'√©valuation peut la modifier
- Modification possible uniquement dans les 7 jours apr√®s cr√©ation

---

### 9. Supprimer une √©valuation

`DELETE /api/evaluations/:id`

**Contraintes :**
- Seul l'auteur de l'√©valuation peut la supprimer
- Suppression possible uniquement dans les 24 heures apr√®s cr√©ation

---

## Logique m√©tier

### R√®gles de validation

1. **Contrat termin√© requis** : Les √©valuations ne peuvent √™tre cr√©√©es que pour des contrats avec le statut `completed`
2. **Participants du contrat** : Seuls les freelances et entreprises impliqu√©s dans le contrat peuvent s'√©valuer mutuellement
3. **Auto-√©valuation interdite** : Un utilisateur ne peut pas s'√©valuer lui-m√™me
4. **√âvaluation unique** : Une seule √©valuation par contrat et par √©valuateur
5. **Note obligatoire** : La note (1-5 √©toiles) est obligatoire, le commentaire est optionnel

### Permissions de modification

- **Modification** : Possible pendant 7 jours apr√®s cr√©ation, uniquement par l'auteur
- **Suppression** : Possible pendant 24 heures apr√®s cr√©ation, uniquement par l'auteur
- **Consultation** : Tous les utilisateurs authentifi√©s peuvent voir les √©valuations

### Calcul des statistiques

- **Note moyenne** : Calcul√©e avec 2 d√©cimales de pr√©cision
- **Distribution** : Comptage des notes par valeur (1 √† 5 √©toiles)
- **Mise √† jour automatique** : Les statistiques sont recalcul√©es √† chaque nouvelle √©valuation

---

## Enrichissement des donn√©es

Tous les endpoints **GET** retournent les √©valuations enrichies avec :

- **`contract`** : Informations du contrat associ√© avec le projet
- **`evaluator`** : Informations de l'√©valuateur (nom, email, type)
- **`evaluated`** : Informations de l'√©valu√© (nom, email, type)

Les requ√™tes utilisent des LEFT JOINs optimis√©s pour r√©cup√©rer ces donn√©es en une seule requ√™te SQL.

---

## Validation

Tous les endpoints utilisent des sch√©mas Zod pour la validation :

- **Rating** : Nombre entier entre 1 et 5
- **Comment** : Cha√Æne optionnelle de 10 √† 500 caract√®res
- **UUIDs** : Validation stricte des identifiants
- **UserType** : Validation contre l'enum (freelance/company)

---

## Pagination & Filtres

Les endpoints de liste supportent :

- **Pagination** : `page` et `limit` (max 100)
- **Filtres** : Par √©valuateur, √©valu√©, note, contrat, projet
- **Tri** : Par date de cr√©ation (DESC par d√©faut)

---

## S√©curit√©

### Authentification
- Tous les endpoints n√©cessitent une authentification sauf `/user/:userId/stats`
- Les middlewares d'authentification appropri√©s sont appliqu√©s selon l'endpoint

### Autorisation
- **Cr√©ation** : V√©rification que l'utilisateur fait partie du contrat
- **Modification/Suppression** : Seul l'auteur peut modifier ses √©valuations
- **Consultation** : Acc√®s libre aux √©valuations (transparence)
- **Filtrage avanc√©** : R√©serv√© aux administrateurs

### Validation des permissions
```typescript
// Exemple de v√©rification dans le service
const isEvaluatorValid =
  (data.evaluator_type === UserType.FREELANCE && data.evaluator_id === contract.freelance_id) ||
  (data.evaluator_type === UserType.COMPANY && data.evaluator_id === contract.company_id);

if (!isEvaluatorValid) {
  throw new Error("L'√©valuateur doit faire partie du contrat");
}
```

---

## Cas d'usage typiques

### 1. Freelance √©value une entreprise
```json
{
  "contract_id": "contract-uuid",
  "evaluator_id": "freelance-uuid",
  "evaluated_id": "company-uuid",
  "evaluator_type": "freelance",
  "evaluated_type": "company",
  "rating": 5,
  "comment": "Excellente communication, paiements rapides, projet int√©ressant."
}
```

### 2. Entreprise √©value un freelance
```json
{
  "contract_id": "contract-uuid",
  "evaluator_id": "company-uuid",
  "evaluated_id": "freelance-uuid",
  "evaluator_type": "company",
  "evaluated_type": "freelance",
  "rating": 4,
  "comment": "Travail de qualit√©, respect des d√©lais, quelques ajustements n√©cessaires."
}
```

### 3. Affichage du profil avec statistiques
Les statistiques d'√©valuation peuvent √™tre affich√©es sur les profils publics :
- Note moyenne sur 5
- Nombre total d'√©valuations
- Distribution des notes
- √âvaluations r√©centes avec commentaires

---

## Int√©gration avec d'autres modules

### Contracts
- V√©rification du statut `completed` avant cr√©ation d'√©valuation
- R√©cup√©ration des participants du contrat (freelance_id, company_id)

### Freelances & Companies
- Enrichissement des donn√©es avec les informations utilisateur
- Validation de l'existence des utilisateurs

### Projects
- Affichage du titre du projet dans les √©valuations
- Contexte pour l'utilisateur lors de l'√©valuation

---

## Base de donn√©es

### Table `evaluations`
```sql
CREATE TABLE evaluations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contract_id UUID NOT NULL REFERENCES contracts(id) ON DELETE CASCADE,
  evaluator_id UUID NOT NULL,
  evaluated_id UUID NOT NULL,
  evaluator_type user_type_enum NOT NULL,
  evaluated_type user_type_enum NOT NULL,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NULL,
  CONSTRAINT unique_evaluation_per_contract UNIQUE (contract_id, evaluator_id, evaluator_type)
);
```

### Vues pr√©-calcul√©es disponibles
```sql
-- Vue des moyennes par freelance
CREATE VIEW freelance_average_rating AS
SELECT
  evaluated_id AS freelance_id,
  AVG(rating) AS average_rating,
  COUNT(*) AS total_evaluations
FROM evaluations
WHERE evaluated_type = 'freelance'
GROUP BY evaluated_id;

-- Vue des moyennes par entreprise
CREATE VIEW company_average_rating AS
SELECT
  evaluated_id AS company_id,
  AVG(rating) AS average_rating,
  COUNT(*) AS total_evaluations
FROM evaluations
WHERE evaluated_type = 'company'
GROUP BY evaluated_id;
```

---

## Exemple d'int√©gration

Dans votre app Express principale :

```ts
import evaluationRoutes from "./src/features/evaluation/evaluation.route";
app.use("/api/evaluations", evaluationRoutes);
```

---

## Endpoints complets disponibles

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| `POST` | `/evaluations` | Cr√©er une √©valuation | Auth |
| `GET` | `/evaluations/:id` | R√©cup√©rer une √©valuation par ID | Auth |
| `PATCH` | `/evaluations/:id` | Mettre √† jour une √©valuation | Auth (auteur) |
| `DELETE` | `/evaluations/:id` | Supprimer une √©valuation | Auth (auteur) |
| `POST` | `/evaluations/filter` | Filtrer les √©valuations | Admin |
| `GET` | `/evaluations/user/:userId/stats` | Statistiques d'un utilisateur | Public |
| `GET` | `/evaluations/user/:userId/given` | √âvaluations donn√©es | Auth |
| `GET` | `/evaluations/user/:userId/received` | √âvaluations re√ßues | Auth |
| `GET` | `/evaluations/user/:userId/summary` | R√©sum√© complet | Auth |
| `GET` | `/evaluations/contract/:contractId` | √âvaluations d'un contrat | Auth |
| `GET` | `/evaluations/contract/:contractId/can-evaluate` | V√©rification permissions | Auth |

---

## Bonnes pratiques

### ‚úÖ √Ä faire
- Encourager les commentaires constructifs
- Afficher les statistiques de mani√®re claire
- Valider les permissions avant chaque action
- Utiliser la pagination pour les listes

### ‚ùå √Ä √©viter
- Permettre les √©valuations sans contrat termin√©
- Autoriser les √©valuations multiples du m√™me contrat
- N√©gliger la validation des permissions
- Exposer des donn√©es sensibles

---

## √âvolutions futures possibles

1. **Syst√®me de r√©ponse** : Permettre aux √©valu√©s de r√©pondre aux √©valuations
2. **Mod√©ration** : Signalement et mod√©ration des √©valuations inappropri√©es
3. **Crit√®res d√©taill√©s** : √âvaluation sur plusieurs crit√®res (communication, qualit√©, d√©lais, etc.)
4. **Recommandations** : Syst√®me de recommandation bas√© sur les √©valuations
5. **Badges** : Attribution de badges bas√©s sur les √©valuations re√ßues

---

## Auteur & Contact

Pour toute question ou am√©lioration du module d'√©valuation, contactez l'√©quipe backend Synkrone.